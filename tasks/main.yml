---
- name: Set OS architecture fact
  ansible.builtin.set_fact:
    os_arch: "{{ [ansible_architecture] | map('extract', deb_arch) | first }}"
  vars:
    deb_arch:
      x86_64: amd64
      aarch64: arm64
      armv7l: armhf

- name: Create configuration root directory
  ansible.builtin.file:
    path: "{{ config_root }}"
    state: directory
    mode: "0775"

- name: Update apt cache if outdated
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true

- name: Install required system packages
  ansible.builtin.apt:
    name:
      - jq
      - git
      - curl
      - ca-certificates
      - apt-transport-https
      - software-properties-common
      - libffi-dev
      - libssl-dev
      - python3-dev
      - python3-pip
      - smartmontools
    state: present
  become: true

- name: Install Docker
  ansible.builtin.import_tasks: docker.yml

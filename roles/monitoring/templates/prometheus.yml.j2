# {{ ansible_managed }}

# Global prometheus config
global:
  scrape_timeout: {{ monitoring_prometheus.scrape_interval }}
  scrape_interval: {{ monitoring_prometheus.scrape_interval }}

# scrape data from exporters
scrape_configs:
{% if monitoring_exporters.node.state == 'present' %}
  - job_name: node
    static_configs:
      - targets: ["{{ ansible_default_ipv4.address }}:{{ monitoring_exporters.node.port }}"]
{% endif %}

{% if monitoring_exporters.cadvisor.state == 'present' %}
  - job_name: cadvisor
    static_configs:
      - targets: ["cadvisor:8080"]
{% endif %}

{% if monitoring_exporters.blackbox.state == 'present' %}
  - job_name: blackbox
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets: {{ monitoring_exporters.blackbox.ping_hosts | to_yaml }}
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox:9115
{% endif %}

{% if monitoring_exporters.speedtest.state == 'present' %}
  - job_name: speedtest
    scrape_interval: "{{ monitoring_exporters.speedtest.scrape_interval }}"
    scrape_timeout: 15m
    static_configs:
      - targets: ["speedtest:9898"]
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'speedtest_.*'
        action: keep
{% endif %}

{% if monitoring_exporters.mikrotik.state == 'present' %}
  - job_name: mikrotik
    static_configs:
      - targets: ["mikrotik:49090"]
{% endif %}

{% if monitoring_exporters.apcupsd.state == 'present' %}
  - job_name: apcupsd
    static_configs:
      - targets: ["apcupsd:9162"]
{% endif %}

{% if monitoring_exporters.smartctl.state == 'present' %}
  - job_name: smartctl
    static_configs:
      - targets: ["smartctl:9633"]
{% endif %}

{% if monitoring_prometheus.extra_config %}
{{ monitoring_prometheus.extra_config | to_yaml | indent(width=2, first=True) }}
{% endif %}

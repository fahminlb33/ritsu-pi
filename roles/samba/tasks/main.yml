---
- name: Ensure samba dependencies are installed # noqa: package-latest
  ansible.builtin.apt:
    name:
      - samba
      - samba-common
    state: present
    update_cache: false

- name: Stat samba mount points
  ansible.builtin.stat:
    path: "{{ item.path }}"
  register: samba_mount_points_stat
  loop: "{{ samba_mount_points }}"

- name: Ensure samba mount point is exists
  ansible.builtin.assert:
    that: "{{ item.stat.exists }}"
    fail_msg: "{{ item.stat.path }} is missing"
  loop: "{{ samba_mount_points_stat.results }}"

- name: Create samba group
  ansible.builtin.group:
    name: "{{ samba_user.group }}"
    state: present

- name: Create samba user
  ansible.builtin.user:
    name: "{{ samba_user.username }}"
    shell: "/sbin/nologin"
    append: true
    group: "{{ samba_user.group }}"
    create_home: false
    state: present

- name: Create samba password
  ansible.builtin.shell: >
    set -o nounset -o pipefail -o errexit &&
    (echo {{ password }}; echo {{ password }}) \
    | smbpasswd -s -a {{ username }}
  args:
    executable: /bin/bash
  vars:
    username: "{{ samba_user.username }}"
    password: "{{ samba_user.password }}"
  become: true
  no_log: true

- name: Create samba config
  ansible.builtin.template:
    src: samba.conf.j2
    dest: /etc/samba/smb.conf
    mode: "0644"
  notify: Restart Samba
